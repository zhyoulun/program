## 原理

NAT是虚拟机借助宿主机的IP上网，外人看来并不知道虚拟机的存在，这是如何work的呢？

我们知道家用路由器一般都是NAT模式，内网用户默认都是192.168.1.x网段，而路由器充当默认网关的角色，所有内网发出的包都将经过路由器，路由器在公网有唯一的IP，所有的包经过路由器修改其源IP都改为了公网IP了，并且会随机映射一个对外端口。当应答回到路由器时，路由器会根据此前的映射关系，将目标IP和PORT改为原先发送请求的内网用户的IP和PORT，这样对于内网用户来说是感知不到路由器的存在的，大家共用路由器的对外IP访问外网。当然，因为大家都在内网同一个网段（路由器基于DHCP分配），所以内网用户互相通讯也没有问题。

当NAT用在虚拟机领域的时候，原理是类似的。只不过一台PC上的若干虚拟机相当于若干内网用户，而宿主机PC充当路由器的角色，虚拟机会在PC上虚拟化一个网络环境：也就是每个虚拟机通过一个无形的网线连接到了无形的路由器上，仅此而已。每个虚拟机实例会通过PC上的虚拟路由器获取DHCP分配的局域网IP，但是这只是本机虚拟出来的局域网，并不是物理局域网。那么，现在虚拟机想访问外网，只需要配置默认网关为PC上虚拟路由器，那么数据包经过虚拟路由器的时候，会将源IP修改为PC的物理网卡的物理局域网IP，发送给物理路由器，之后的事情和之前描述的一样。

上面的虚拟路由器其实是宿主机上一张虚拟的网卡，而虚拟机则将默认网关指向了这张网卡，从而有机会进行IP篡改。

如果你理解了上面这段描述，那么我们可以分析出这样的结论：

1. 1个PC上的若干虚拟机之间，可以互相通讯，中介就是虚拟路由器。
2. 虚拟机可以访问外网，也可以访问物理局域网，但是无法访问其他PC上的虚拟机。
3. 外人（物理局域网其他PC）无法直接访问虚拟机，这和物理路由器外网的用户无法直接访问内网用户一个道理。（反向进入内网需要DNAT，如果你了解lvs的话）
4. 虚拟机可以访问宿主机的物理IP，流程是先经过宿主NAT修改源IP和源PORT，通过物理网卡发出到局域网络中，又被物理网卡接收处理。
5. 宿主机无法访问虚拟机，这是因为宿主机的物理网卡和内网其他网卡的角色一样，对于虚拟路由器来说都是”外人”，不可能进入到虚拟局域网的内网用户。

## SNAT vs DNAT

从定义上讲，SNAT是原地址转换，DNAT是目标地址转换。区分这两个功能可以简单的由服务的发起者是谁来区分，内部地址要访问公网上的服务时，内部地址会主动发起连接，将内部地址转换成公有ip。网关这个地址转换称为SNAT. 当内部需要对外提供服务时，外部发起主动连接，路由器或着防火墙的网关接收到这个连接，然后把连接转换到内部，此过程是由带公有ip的网关代替内部服务来接收外部的连接，然后在内部做地址转换，此转换称为DNAT.主要用于内部服务对外发布。

## 参考

- [理解桥接bridge和dhcp的原理](https://yuerblog.cc/2017/01/22/understand-bridge-and-dhcp/)
- [SNAT 和 DNAT 的区别](https://www.jianshu.com/p/34c62c632527)