## 基本流程

SSL/TLS协议的基本思路是采用公钥加密法，也就是说，客户端先向服务器端索要公钥，然后用公钥加密信息，服务器收到密文后，用自己的私钥解密。

1. 客户端向服务器端索要并验证公钥。
2. 双方协商生成"对话密钥"。
3. 双方采用"对话密钥"进行加密通信。

上面过程的前两步，又称为"握手阶段"（handshake）。

## 握手阶段的详细过程

![](/static/images/2102/p005.png)

"握手阶段"涉及四次通信，我们一个个来看。需要注意的是，"握手阶段"的所有通信都是明文的。

1. 客户端发出请求（ClientHello）
   1. 客户端主要向服务器提供以下信息。
      1. 支持的协议版本，比如TLS 1.0版。
      2. 一个客户端生成的随机数，稍后用于生成"对话密钥"。
      3. 支持的加密方法，比如RSA公钥加密。
      4. 支持的压缩方法。
2. 服务器回应（SeverHello）
   1. 服务器的回应包含以下内容。
      1. 确认使用的加密通信协议版本，比如TLS 1.0版本。如果浏览器与服务器支持的版本不一致，服务器关闭加密通信。
      2. 一个服务器生成的随机数，稍后用于生成"对话密钥"。
      3. 确认使用的加密方法，比如RSA公钥加密。
      4. 服务器证书。
   2. 除了上面这些信息，如果服务器需要确认客户端的身份，就会再包含一项请求，要求客户端提供"客户端证书"。比如，金融机构往往只允许认证客户连入自己的网络，就会向正式客户提供USB密钥，里面就包含了一张客户端证书。
3. 客户端回应
   1. 客户端收到服务器回应以后，首先验证服务器证书。如果证书不是可信机构颁布、或者证书中的域名与实际域名不一致、或者证书已经过期，就会向访问者显示一个警告，由其选择是否还要继续通信。
   2. 如果证书没有问题，客户端就会从证书中取出服务器的公钥。然后，向服务器发送下面三项信息。
      1. 一个随机数。该随机数用服务器公钥加密，防止被窃听。
      2. 编码改变通知，表示随后的信息都将用双方商定的加密方法和密钥发送。
      3. 客户端握手结束通知，表示客户端的握手阶段已经结束。这一项同时也是前面发送的所有内容的hash值，用来供服务器校验。
4. 服务器的最后回应
   1. 服务器收到客户端的第三个随机数pre-master key之后，计算生成本次会话所用的"会话密钥"。然后，向客户端最后发送下面信息。
      1. 编码改变通知，表示随后的信息都将用双方商定的加密方法和密钥发送。
      2. 服务器握手结束通知，表示服务器的握手阶段已经结束。这一项同时也是前面发送的所有内容的hash值，用来供客户端校验。



## 参考

- [SSL/TLS协议运行机制的概述](https://www.ruanyifeng.com/blog/2014/02/ssl_tls.html)